<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Greets Graf</title>
</style>
<script type="text/javascript">
	"use strict";

	function debounce(func, cancelFunc, timeout = 200) {
		let timer;
		return (...args) => {
			cancelFunc();
			clearTimeout(timer);
			timer = setTimeout(() => { func.apply(this, args); }, timeout);
		}
	}

	function sendRequest(method, path, query, body, funcDone, funcError) {
		var req = new XMLHttpRequest();
		if (query) {
			var params = new URLSearchParams(query);
			path = path + "?" + params.toString();
		}
		req.open(method, path, true);
		req.onreadystatechange = function () {
			if (req.readyState == XMLHttpRequest.DONE) {
				var status = req.status;
				if (status === 0 || (status >= 200 && status < 400)) {
					if (funcDone)
						funcDone(req.responseText, status);
				} else {
					if (funcError)
						funcError(req.responseText, status);
				}
			}
		}

		if (body) {
			req.setRequestHeader("Content-Type", "application/json");
			req.send(JSON.stringify(body));
		} else {
			req.send();
		}

		return req;
	}

	var currentSearch = {}

	function searchCancel() {
		if (currentSearch.searchXhr)
			currentSearch.searchXhr.abort();
		currentSearch = {}
	}

	function searchRequest() {
		var name = document.getElementById("in_prod").value;
		var element_result = document.getElementById("prods");

		var query = {
			name: name,
		};

		currentSearch.searchXhr = sendRequest("GET", "/v1/prods/search", query, null,
			(response) => {
				var json = response ? JSON.parse(response) : null;
				var html = `
<table class="functions">
<tr><th>id</th><th>name</th></tr>`;
				if (json) {
					json.forEach((obj) => {
							html += "<tr><td>" + obj["ID"] + "</td><td>" + obj["Name"] + "</td></tr>";
					});
				}
				html += "</table>";
				element_result.innerHTML = html;
			},
			() => {
			}
		)
	}

	const searchFormEdited = debounce(() => searchRequest(), () => searchCancel());

	function loadProd() {
		var pid = parseInt(document.getElementById("in_prod_id").value);
		if (isNaN(pid)) {
			return;
		}

		var xhr = sendRequest("GET", "/v1/prods/" + pid, null, null,
			(response) => {
				document.getElementById("prod").innerHTML = response;
			},
			(response) => {
				document.getElementById("prod").innerHTML = "ERROR:" + response;
			}
		)

			/*
		var gxhr = sendRequest("GET", "/v1/greets/search", {prod:pid}, null,
			(response) => {
				document.getElementById("greets").innerHTML = response;
			},
			(response) => {
				document.getElementById("greets").innerHTML = "ERROR:" + response;
			}
		)
			*/
	}

	window.onload = function() {
	}
</script>
	</head>
	<body>
		<h2>Let's find some greetings</h2>
		Prod name: <input type="text" id="in_prod" onchange="searchFormEdited()" onkeyup="searchFormEdited()"/><br/>
		<div id="prods"></div>
		Prod id: <input type="text" id="in_prod_id"/><button onclick="loadProd()">Load</button><br/>
		<div id="prod"></div>
		<div id="greets"></div>
	</body>
</html>
