<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Greets Graf</title>
</style>
<script type="text/javascript">
	"use strict";

	function $(name) { return document.getElementById(name); }

	function Tag(name, attrs, body, children) {
		let elem = document.createElement(name);
		if (body) {
			elem.innerHTML = body;
		}
		for (let k in attrs) {
			elem[k] = attrs[k];
		}
		for (let i in children) {
			elem.appendChild(children[i]);
		}
		return elem;
	}

	function Text(text) {
		return document.createTextNode(text);
	}

	function debounce(func, cancelFunc, timeout = 200) {
		let timer;
		return (...args) => {
			cancelFunc();
			clearTimeout(timer);
			timer = setTimeout(() => { func.apply(this, args); }, timeout);
		}
	}

	function sendRequest(method, path, query, body, funcDone, funcError) {
		let req = new XMLHttpRequest();
		if (query) {
			let params = new URLSearchParams(query);
			path = path + "?" + params.toString();
		}
		req.open(method, path, true);
		req.onreadystatechange = function () {
			if (req.readyState == XMLHttpRequest.DONE) {
				let status = req.status;
				if (status === 0 || (status >= 200 && status < 400)) {
					if (funcDone)
						funcDone(req.responseText, status);
				} else {
					if (funcError)
						funcError(req.responseText, status);
				}
			}
		}

		if (body) {
			req.setRequestHeader("Content-Type", "application/json");
			req.send(JSON.stringify(body));
		} else {
			req.send();
		}

		return req;
	}




	let currentSearch = {}

	function searchCancel() {
		if (currentSearch.searchXhr)
			currentSearch.searchXhr.abort();
		currentSearch = {}
	}

	function searchRequest(value, prod_list) {
		console.log("Search request: ", value);
		let name = value;
		let element_result = document.getElementById("prods");

		let query = {
			name: name,
		};

		currentSearch.searchXhr = sendRequest("GET", "/v1/prods/search", query, null,
			(response) => {
				console.log("Received reply for: ", value, ": ", response);
				let json = response ? JSON.parse(response) : null;

				let html = `
<table class="functions">
<tr><th>id</th><th>name</th></tr>`;
				if (json) {
					json.forEach((obj) => {
						prod_list.appendChild(Tag(
							"option", {value: obj.ID}, null, [
									Text(obj.Name + (obj.Disambiguation ? " (" + obj.Disambiguation + ")" : "")),
									Text(" by "),
									(obj.Groups && obj.Groups.length > 0) ? Tag("strong", null, obj.Groups[0].Name) : Text("N/A")]));
							html += "<tr><td>" + obj["ID"] + "</td><td>" + obj["Name"] + "</td></tr>";
					});
				}
				html += "</table>";
				element_result.innerHTML = html;
			},
			() => {
			}
		)
	}

	const searchFormEdited = (value) => {
		let prod_list = $('prod_matches');
		prod_list.innerHTML = "";

		debounce(() => searchRequest(value, prod_list), () => searchCancel())();
	}

	function Greet(index, data) {
		this.index = index;
		this.data = data ? data : {};
	}

	Greet.prototype.createRow = function() {
		let tag_input_group =  Tag('input', {
			type: "text",
			value: this.data.GreeteeID
		});
		let tag_input_note = Tag('input', {
			type: "text",
			value: this.data.Reference
		});
		let tag_button_delete = Tag('button', {
			onclick: () => {
				if (confirm("Are you sure you want to delete this greet?")) { // TODO show greet info
					this.delete();
				}
			}
		}, "Delete");

		return Tag('tr', {class: "greet"}, null, [
			Tag('td', null, null, [
					Text("Group: "), tag_input_group,
					Text(" Note: "), tag_input_note,
					Text(" "), tag_button_delete
			])
		]);
	};

	Greet.prototype.delete = function() {
		let xhr = sendRequest("DELETE", "/v1/greets/" + this.data.ID, null, null,
			(response, status) => {
				console.log(status, response);
				loadProd();
			},
			(response, status) => {
				console.log(status, response)
				document.getElementById("greets_list").innerHTML = "ERROR:" + response;
			}
		)
	}

	function loadProd() {
		let pid = parseInt(document.getElementById("in_prod_id").value);
		if (isNaN(pid)) {
			return;
		}

		let prod_container = document.getElementById("prod_container");
		prod_container.style.display = "none";
		let prod = document.getElementById("prod");
		prod.innerHTML = "";

		let greets_list = document.getElementById("greets_list");
		greets_list.innerHTML = "";

		let xhr = sendRequest("GET", "/v1/prods/" + pid, null, null,
			(response) => {
				let json = JSON.parse(response);

				let html = "<strong>" + json.Name + "</strong> by ";
				for (let gi in json.Groups) {
					let g = json.Groups[gi];
					if (gi > 0) {
						html += " and ";
					}
					html += '<a href="https://www.pouet.net/groups.php?which=' + g.ID + '">' + g.Name + '</a>';
				}
				html += " <br />";
				prod.innerHTML = html;
				if (json.Screenshot) {
					prod.appendChild(Tag('img', {src: json.Screenshot}));
					prod.appendChild(Tag('br'));
				}
				prod.appendChild(Tag('a', {href: "https://www.pouet.net/prod.php?which=" + json.ID}, '[pouet.net]'));
				prod.appendChild(Text(" "));
				prod.appendChild(Tag('a', {href: "https://demozoo.org/productions/" + json.Demozoo}, '[demozoo]'));
				prod.appendChild(Text(" "));
				prod.appendChild(Tag('a', {href: "https://www.pouet.net/prod_nfo.php?which=" + json.ID}, '[nfo]'));

				if (json.Video) {
					prod.appendChild(Text(" "));
					prod.appendChild(Tag('a', {href: json.Video}, '[video]'));
				}

				for (let i in json.Greets) {
					let greet = new Greet(i, json.Greets[i]);
					greets_list.appendChild(greet.createRow());
				}

				prod_container.style.display = "block";
			},
			(response) => {
				document.getElementById("prod").innerHTML = "ERROR:" + response;
			}
		)
	}
	function greetAdd() {
		let pid = parseInt(document.getElementById("in_prod_id").value);
		if (isNaN(pid)) {
			return;
		}

		let gid = parseInt(document.getElementById("greet_add_group_id").value);
		if (isNaN(gid)) {
			return;
		}

		let reference = document.getElementById("greed_add_reference").value;

		let body = {
			ProdId: pid,
			GroupId: gid,
			Reference: reference
		};

		let xhr = sendRequest("POST", "/v1/greets/", null, body,
			(response, status) => {
				console.log(status, response);
				loadProd();
			},
			(response, status) => {
				console.log(status, response)
				document.getElementById("greets_list").innerHTML = "ERROR:" + response;
			}
		)
	}

	window.onload = function() {
		$("in_prod_id").onkeyup = (e) => {
			if (e.key === "Enter" || e.keyCode === 13) {
				loadProd();
			}
		};

		let prod_search = $("in_prod");
		prod_search.addEventListener('change', (e) => {
			console.log("Change: ", e);
		});
		prod_search.addEventListener('input', (e) => {
			console.log("Input: ", e);
			if (e.inputType === "insertReplacementText") {
				$('in_prod_id').value = e.data;
				loadProd();
				return;
			}

			searchFormEdited(prod_search.value);
		});
	}
</script>
	</head>
	<body>
		<h1>Let's fill some greetings</h1>
		<input type="text" list="prod_matches" id="in_prod" placehoder="Prod name...">
		<!-- onchange="searchFormEdited()" onkeyup="searchFormEdited()"/> -->
		<datalist id="prod_matches"></datalist>
		<br/>
		<div id="prods"></div>
		Prod id: <input type="text" id="in_prod_id"/><button onclick="loadProd()">Load</button><br/>

		<div id="prod_container" style="display: none;">
			<div id="prod"></div>
			<strong>Greetings:</strong><br/>
			<div id="greets_list"></div>
			Add new: GroupID: <input type="text" id="greet_add_group_id"> Note:<input type="text" placeholder="e.g. 1m37s or nfo" id="greed_add_reference"> <button onclick="greetAdd()">add</button>
		</div>
	</body>
</html>
