<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Greets Graf</title>
</style>
<script type="text/javascript">
	"use strict";

	function debounce(func, cancelFunc, timeout = 200) {
		let timer;
		return (...args) => {
			cancelFunc();
			clearTimeout(timer);
			timer = setTimeout(() => { func.apply(this, args); }, timeout);
		}
	}

	function sendRequest(method, path, query, body, funcDone, funcError) {
		var req = new XMLHttpRequest();
		if (query) {
			var params = new URLSearchParams(query);
			path = path + "?" + params.toString();
		}
		req.open(method, path, true);
		req.onreadystatechange = function () {
			if (req.readyState == XMLHttpRequest.DONE) {
				var status = req.status;
				if (status === 0 || (status >= 200 && status < 400)) {
					if (funcDone)
						funcDone(req.responseText, status);
				} else {
					if (funcError)
						funcError(req.responseText, status);
				}
			}
		}

		if (body) {
			req.setRequestHeader("Content-Type", "application/json");
			req.send(JSON.stringify(body));
		} else {
			req.send();
		}

		return req;
	}

	var currentSearch = {}

	function searchCancel() {
		if (currentSearch.searchXhr)
			currentSearch.searchXhr.abort();
		currentSearch = {}
	}

	function searchRequest() {
		var name = document.getElementById("in_prod").value;
		var element_result = document.getElementById("prods");

		var query = {
			name: name,
		};

		currentSearch.searchXhr = sendRequest("GET", "/v1/prods/search", query, null,
			(response) => {
				var json = response ? JSON.parse(response) : null;
				var html = `
<table class="functions">
<tr><th>id</th><th>name</th></tr>`;
				if (json) {
					json.forEach((obj) => {
							html += "<tr><td>" + obj["ID"] + "</td><td>" + obj["Name"] + "</td></tr>";
					});
				}
				html += "</table>";
				element_result.innerHTML = html;
			},
			() => {
			}
		)
	}

	const searchFormEdited = debounce(() => searchRequest(), () => searchCancel());

	function Greet(index, data) {
		this.index = index;
		this.data = data ? data : {};
	}

	function Tag(name, body, attrs) {
		var elem = document.createElement(name);
		if (body) {
			elem.innerHTML = body;
		}
		for (var k in attrs) {
			elem[k] = attrs[k];
		}
		return elem;
	}

	function greetDelete(id) {
		if (!id) return;

		var xhr = sendRequest("DELETE", "/v1/greets/" + id, null, null,
			(response, status) => {
				console.log(status, response);
				loadProd();
			},
			(response, status) => {
				console.log(status, response)
				document.getElementById("greets_list").innerHTML = "ERROR:" + response;
			}
		)
	}

	Greet.prototype.makeHtml = function() {
		var html = "<tr>";
		html += '<td>Group: <input type="text" id="greet_' + this.index + '_group" value="' + this.data.GreeteeID + '"> ';
			html += 'Reference: <input type="text" id="greet_' + this.index + '_reference" value="' + this.data.Reference + '"></td>';
			html += '<td><button>Save</button> <button onclick="greetDelete('+this.data.ID+')">Delete</button></td>';
		html += "</tr>";
		return html;
	};

	function loadProd() {
		var pid = parseInt(document.getElementById("in_prod_id").value);
		if (isNaN(pid)) {
			return;
		}

		var prod_container = document.getElementById("prod_container");
		prod_container.style.display = "none";
		var prod = document.getElementById("prod");
		prod.innerHTML = "";

		var xhr = sendRequest("GET", "/v1/prods/" + pid, null, null,
			(response) => {
				var json = JSON.parse(response);

				var html = "<strong>" + json.Name + "</strong> by ";
				for (var gi in json.Groups) {
					var g = json.Groups[gi];
					if (gi > 0) {
						html += " and ";
					}
					html += '<a href="https://www.pouet.net/groups.php?which=' + g.ID + '">' + g.Name + '</a>';
				}
				html += " <br />";
				prod.innerHTML = html;
				prod.appendChild(Tag('a', '[pouet.net]', {href: "https://www.pouet.net/prod.php?which=" + json.ID}));
				prod.appendChild(Tag('a', '[demozoo]', {href: "https://demozoo.org/productions/" + json.Demozoo}));

				if (json.Video) {
					prod.appendChild(Tag('a', '[video]', {href: json.Video}));
				}

				var html_greets = "<table>";
				for (var i in json.Greets) {
					var greet = new Greet(i, json.Greets[i]);
					html_greets += greet.makeHtml();
				}
				document.getElementById("greets_list").innerHTML = html_greets + "</table>";

				prod_container.style.display = "block";
			},
			(response) => {
				document.getElementById("prod").innerHTML = "ERROR:" + response;
			}
		)
	}

	function greetAdd() {
		var pid = parseInt(document.getElementById("in_prod_id").value);
		if (isNaN(pid)) {
			return;
		}

		var gid = parseInt(document.getElementById("greet_add_group_id").value);
		if (isNaN(gid)) {
			return;
		}

		var reference = document.getElementById("greed_add_reference").value;

		var body = {
			ProdId: pid,
			GroupId: gid,
			Reference: reference
		};

		var xhr = sendRequest("POST", "/v1/greets/", null, body,
			(response, status) => {
				console.log(status, response);
				loadProd();
			},
			(response, status) => {
				console.log(status, response)
				document.getElementById("greets_list").innerHTML = "ERROR:" + response;
			}
		)
	}

	window.onload = function() {
	}
</script>
	</head>
	<body>
		<h2>Let's fill some greetings</h2>
		Prod name: <input type="text" id="in_prod" onchange="searchFormEdited()" onkeyup="searchFormEdited()"/><br/>
		<div id="prods"></div>
		Prod id: <input type="text" id="in_prod_id"/><button onclick="loadProd()">Load</button><br/>

		<div id="prod_container" style="display: none;">
			<div id="prod"></div>
			<strong>Greetings:</strong><br/>
			<div id="greets_list"></div>
			Add new: GroupID: <input type="text" id="greet_add_group_id"> Note:<input type="text" placeholder="e.g. 1m37s or nfo" id="greed_add_reference"> <button onclick="greetAdd()">add</button>
		</div>
	</body>
</html>
