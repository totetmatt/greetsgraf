<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Greets Graf</title>

<style type="text/css">
html {
  box-sizing: border-box;
}
*, *:before, *:after {
  box-sizing: inherit;
}

.autocomplete {
	position: relative;
	display: inline-block;
}

.autocomplete-items {
	z-index: 99;
	position: absolute;
	top: 100%;
	left: 0;
	right: 0;
}

.autocomplete-item {
	background-color: #fefefe;
	cursor: pointer;
	border: 1px solid #eee;
	border-top: none;
}

.autocomplete-item:hover {
	background-color: #e9e9e9;
}

.item-inactive {
	padding: 5px;
}

.item-inactive .group {
	color: #777;
}

.item-active {
	padding: 5px;
	background-color: DodgerBlue !important;
	color: #fff;
}

.item-active .group {
	color: #ccc;
}

</style>

<script type="text/javascript">
	"use strict";

	function $(name) { return document.getElementById(name); }

	function Tag(name, attrs, body, children) {
		let elem = document.createElement(name);
		if (body) {
			elem.innerHTML = body;
		}
		for (let k in attrs) {
			elem.setAttribute(k, attrs[k]);
		}
		for (let i in children) {
			elem.appendChild(children[i]);
		}
		return elem;
	}

	function Text(text) {
		return document.createTextNode(text);
	}

	function debounce(func, cancelFunc, timeout = 200) {
		let timer;
		return (...args) => {
			cancelFunc();
			clearTimeout(timer);
			timer = setTimeout(() => { func.apply(this, args); }, timeout);
		}
	}

	function sendRequest(method, path, query, body, funcDone, funcError) {
		let req = new XMLHttpRequest();
		if (query) {
			let params = new URLSearchParams(query);
			path = path + "?" + params.toString();
		}
		req.open(method, path, true);
		req.onreadystatechange = function () {
			if (req.readyState == XMLHttpRequest.DONE) {
				let status = req.status;
				if (status === 0 || (status >= 200 && status < 400)) {
					if (funcDone)
						funcDone(req.responseText, status);
				} else {
					if (funcError)
						funcError(req.responseText, status);
				}
			}
		}

		if (body) {
			req.setRequestHeader("Content-Type", "application/json");
			req.send(JSON.stringify(body));
		} else {
			req.send();
		}

		return req;
	}

	function Greet(index, data) {
		this.index = index;
		this.data = data ? data : {};
	}

	Greet.prototype.createRow = function() {
		let tag_input_group =  Tag('input', {
			type: "text",
			value: this.data.GreeteeID
		});
		let tag_input_note = Tag('input', {
			type: "text",
			value: this.data.Reference
		});
		let tag_button_delete = Tag('button', {
			onclick: () => {
				if (confirm("Are you sure you want to delete this greet?")) { // TODO show greet info
					this.delete();
				}
			}
		}, "Delete");

		return Tag('tr', {class: "greet"}, null, [
			Tag('td', null, null, [
					Text("Group: "), tag_input_group,
					Text(" Note: "), tag_input_note,
					Text(" "), tag_button_delete
			])
		]);
	};

	Greet.prototype.delete = function() {
		let xhr = sendRequest("DELETE", "/v1/greets/" + this.data.ID, null, null,
			(response, status) => {
				console.log(status, response);
				loadProd();
			},
			(response, status) => {
				console.log(status, response)
				document.getElementById("greets_list").innerHTML = "ERROR:" + response;
			}
		)
	}

	function loadProd() {
		let pid = parseInt(document.getElementById("in_prod_id").value);
		if (isNaN(pid)) {
			return;
		}

		let prod_container = document.getElementById("prod_container");
		prod_container.style.display = "none";
		let prod = document.getElementById("prod");
		prod.innerHTML = "";

		let greets_list = document.getElementById("greets_list");
		greets_list.innerHTML = "";

		let xhr = sendRequest("GET", "/v1/prods/" + pid, null, null,
			(response) => {
				let json = JSON.parse(response);

				let html = "<strong>" + json.Name + "</strong> by ";
				for (let gi in json.Groups) {
					let g = json.Groups[gi];
					if (gi > 0) {
						html += " and ";
					}
					html += '<a href="https://www.pouet.net/groups.php?which=' + g.ID + '">' + g.Name + '</a>';
				}
				html += " <br />";
				prod.innerHTML = html;
				if (json.Screenshot) {
					prod.appendChild(Tag('img', {src: json.Screenshot}));
					prod.appendChild(Tag('br'));
				}
				prod.appendChild(Tag('a', {href: "https://www.pouet.net/prod.php?which=" + json.ID}, '[pouet.net]'));
				prod.appendChild(Text(" "));
				prod.appendChild(Tag('a', {href: "https://demozoo.org/productions/" + json.Demozoo}, '[demozoo]'));
				prod.appendChild(Text(" "));
				prod.appendChild(Tag('a', {href: "https://www.pouet.net/prod_nfo.php?which=" + json.ID}, '[nfo]'));

				if (json.Video) {
					prod.appendChild(Text(" "));
					prod.appendChild(Tag('a', {href: json.Video}, '[video]'));
				}

				for (let i in json.Greets) {
					let greet = new Greet(i, json.Greets[i]);
					greets_list.appendChild(greet.createRow());
				}

				prod_container.style.display = "block";
			},
			(response) => {
				document.getElementById("prod").innerHTML = "ERROR:" + response;
			}
		)
	}
	function greetAdd() {
		let pid = parseInt(document.getElementById("in_prod_id").value);
		if (isNaN(pid)) {
			return;
		}

		let gid = parseInt(document.getElementById("greet_add_group_id").value);
		if (isNaN(gid)) {
			return;
		}

		let reference = document.getElementById("greed_add_reference").value;

		let body = {
			ProdId: pid,
			GroupId: gid,
			Reference: reference
		};

		let xhr = sendRequest("POST", "/v1/greets/", null, body,
			(response, status) => {
				console.log(status, response);
				loadProd();
			},
			(response, status) => {
				console.log(status, response)
				document.getElementById("greets_list").innerHTML = "ERROR:" + response;
			}
		)
	}

	function Autocomplete(args) {
		this.input_field = args.input;
		this.parent = this.input_field.parentNode;
		this.suggestionContainer = Tag('div', {class: 'autocomplete-items'});
		this.parent.appendChild(this.suggestionContainer);
		this.focus = -1;

		// funcFindVariants(value, funcSuccess(suggestion[] {.render}, funcFail)
		this.funcFindVariants = args.funcFindVariants;
		this.funcSelect = args.funcSelect; // (suggestion)
		this.current_search = null;

		this.input_field.addEventListener('input', (e) => {
			this.clearSuggestionList();
			let value = this.input_field.value;
			if (value) {
				this.requestSuggestionList(value);
			}
		});

		const KEY_DOWN = 40;
		const KEY_UP = 38;
		const KEY_ENTER = 13;

		this.input_field.addEventListener('keydown', (e) => {
			if (!this.suggestions)
				return;

			if (e.keyCode == KEY_DOWN) {
				e.preventDefault();
				this.changeFocus(1);
			} else if (e.keyCode == KEY_UP) {
				e.preventDefault();
				this.changeFocus(-1);
			} else if (e.keyCode == KEY_ENTER) {
				e.preventDefault();
				if (this.focus >= 0 && this.focus < this.suggestions.length) {
					this.select(this.focus);
				}
			}
		});
	}

	Autocomplete.prototype.select = function(index) {
		let selection = this.suggestions[index];
		this.clearSuggestionList();
		this.input_field.blur();
		this.funcSelect(selection);
	}

	Autocomplete.prototype.changeFocus = function(delta) {
		let prevFocus = this.focus;
		this.focus += delta;
		if (this.focus < 0) this.focus = this.suggestions.length - 1;
		if (this.focus >= this.suggestions.length) this.focus = 0;

		if (prevFocus >= 0 && prevFocus < this.suggestions.length)
			this.suggestions[prevFocus].deactivate();
		if (this.focus >= 0 && this.focus < this.suggestions.length)
			this.suggestions[this.focus].activate();
	}

	Autocomplete.prototype.clearSuggestionList = function() {
		if (this.current_search) {
			this.current_search.abort();
			this.current_search = null;
		}
		this.suggestionContainer.innerHTML = "";
		this.focus = -1;
		this.suggestions = [];
	}

	Autocomplete.prototype.requestSuggestionList = function(value) {
		this.clearSuggestionList();
		debounce(() => {
			this.clearSuggestionList();
			this.current_search = this.funcFindVariants(value, (suggestions) => {
				this.suggestions = suggestions;
				for (let i in this.suggestions) {
					let item = this.suggestions[i].element;
					// TODO add click
					let elem = Tag('div', {class:'autocomplete-item'}, null, [item]);
					elem.addEventListener("click", (e) => {
						this.select(i);
					});
					this.suggestionContainer.appendChild(elem);
				}
			}, (error) => {
				abort("LOL ERROR", error);
			});
		}, () => {}
		)();
	}

	window.onload = function() {
		$("in_prod_id").onkeyup = (e) => {
			if (e.key === "Enter" || e.keyCode === 13) {
				loadProd();
			}
		};

		let autocomplete = new Autocomplete({
			input: $('in_prod'),
			funcSelect: (item) => {
				console.log("Selected", item);
				$('in_prod_id').value = item.id;
				loadProd();
			},
			funcFindVariants: (value, found, error) => {
				let query = { name: value };
				let xhr = sendRequest("GET", "/v1/prods/search", query, null,
					(response) => {
						let json = response ? JSON.parse(response) : null;
						if (!json) {
							found([]);
							return;
						}

						let suggestions = [];

						json.forEach((obj) => {
							let element = Tag('div', {class: "item-inactive"}, null, [
								Text(obj.Name + (obj.Disambiguation ? " (" + obj.Disambiguation + ")" : "")),
								Text(" by "),
									(obj.Groups && obj.Groups.length > 0) ? Tag("span", {class: "group"}, obj.Groups[0].Name) : Text("N/A")]);
							suggestions.push({
								id: obj.ID,
								element: element,
								deactivate: () => { element.setAttribute("class", "item-inactive"); },
								activate: () => { element.setAttribute("class", "item-active"); },
							});
						});

						found(suggestions);
					},
					(response, status) => {
						error({http_status: status, reponse: response});
					}
				)
			}
		});
	}
</script>
	</head>
	<body>
		<h1>Let's fill some greetings</h1>
		Demofinder 2000:
		<div id="prod_search" class="autocomplete" style="width: 320px;">
			<input type="text" id="in_prod" style="width: 100%;" placehoder="Prod name...">
		</div>
		(Or input prod id directly: <input type="text" id="in_prod_id"/><button onclick="loadProd()">Load</button>)

		<br/>

		<div id="prod_container" style="display: none;">
			<div id="prod"></div>
			<strong>Greetings:</strong><br/>
			<div id="greets_list"></div>
			Add new: GroupID: <input type="text" id="greet_add_group_id"> Note:<input type="text" placeholder="e.g. 1m37s or nfo" id="greed_add_reference"> <button onclick="greetAdd()">add</button>
		</div>
	</body>
</html>
